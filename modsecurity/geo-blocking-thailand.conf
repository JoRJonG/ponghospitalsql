# ModSecurity Geo-blocking Rules for Thailand Only
# For cPanel ModSecurity (WAF) - Ready to deploy
# 
# Installation Steps:
# 1. Copy this file to: /etc/modsecurity/rules/ (or ask hosting to do it)
# 2. Include in ModSecurity config:
#    Include /etc/modsecurity/rules/geo-blocking-thailand.conf
# 3. Or paste rules into cPanel WAF "Custom rules" section
# 4. Test and Deploy

# ============================================
# GEO-BLOCKING: BLOCK NON-THAILAND IPs
# ============================================

# SecRule ID:1000 - Log all access with country code
SecRule REMOTE_ADDR "@rx .*" \
    "id:1000,\
    phase:1,\
    pass,\
    nolog,\
    setvar:country=%{GEO:COUNTRY_CODE}"

# SecRule ID:1001 - MAIN RULE: Block non-Thailand countries
# This rule blocks all IPs that are NOT from Thailand (TH)
SecRule GEO:COUNTRY_CODE "!^(TH|)$" \
    "id:1001,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    auditlog,\
    msg:'GEO-BLOCKED: Access denied from country %{GEO:COUNTRY_CODE}',\
    logdata:'IP: %{REMOTE_ADDR} | Country: %{GEO:COUNTRY_CODE} | URI: %{REQUEST_URI}',\
    tag:'geo-blocking',\
    tag:'access-control',\
    ctl:auditLogParts=+E"

# SecRule ID:1002 - Exception: Allow private/local IP ranges
# Skip geo-blocking for localhost and private IPs
SecRule REMOTE_ADDR "@ipMatch 127.0.0.1,::1,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16" \
    "id:1002,\
    phase:1,\
    pass,\
    nolog,\
    skip:1"

# ============================================
# OPTIONAL: Enhanced Logging
# ============================================

# SecRule ID:1003 - Log all blocked attempts
SecRule id "@eq 1001" \
    "id:1003,\
    phase:5,\
    pass,\
    nolog,\
    msg:'Geo-blocking rule triggered',\
    exec:/opt/modsecurity/scripts/geo-block-alert.sh"

# ============================================
# TESTING RULES (Comment out after testing)
# ============================================

# Test: Log all requests (disable after testing)
# SecRule REQUEST_LINE "@rx .*" \
#     "id:1004,\
#     phase:1,\
#     pass,\
#     log,\
#     msg:'TEST: All requests logged - Country: %{GEO:COUNTRY_CODE}'"

# Test: Allow specific IP for testing (replace with your IP)
# SecRule REMOTE_ADDR "@eq 37.159.25.38" \
#     "id:1005,\
#     phase:1,\
#     pass,\
#     nolog,\
#     skip:2"
