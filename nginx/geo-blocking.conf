# Geo-blocking configuration for nginx
# Block all countries except Thailand (TH)

# GeoIP2 configuration (requires ngx_http_geoip2_module)
# Install: apt-get install nginx-module-geoip2 libmaxminddb0 libmaxminddb-dev mmdb-bin
# Download GeoLite2: https://dev.maxmind.com/geoip/geolite2-free-geolocation-data

geoip2 /usr/share/GeoIP/GeoLite2-Country.mmdb {
    auto_reload 5m;
    $geoip2_metadata_country_build metadata build_epoch;
    $geoip2_data_country_code country iso_code;
    $geoip2_data_country_name country names en;
}

# Map country code to allowed status
map $geoip2_data_country_code $allowed_country {
    default no;
    TH yes;           # Thailand
    ""  yes;          # Unknown (localhost, private IPs)
}

# Whitelist for specific IPs (optional)
geo $whitelist_ip {
    default 0;
    127.0.0.1 1;      # Localhost IPv4
    ::1 1;            # Localhost IPv6
    # Add your trusted IPs here if needed
    # 1.2.3.4 1;
}

# Final decision: allow if whitelisted OR from Thailand
map $whitelist_ip$allowed_country $geo_block {
    default 1;        # Block by default
    ~*1 0;            # Allow if whitelisted (whitelist_ip = 1)
    ~*yes 0;          # Allow if from Thailand
}
